/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Inject, Injectable, Injector, Optional } from "@angular/core";
import { DYNAMIC_MATCHERS } from "./dynamic-form-relation.matchers";
import { AND_OPERATOR, OR_OPERATOR } from "../model/misc/dynamic-form-control-relation.model";
import { startWith } from "rxjs/operators";
import { merge } from "rxjs";
import * as i0 from "@angular/core";
import * as i1 from "./dynamic-form-relation.matchers";
var DynamicFormRelationService = /** @class */ (function () {
    function DynamicFormRelationService(DYNAMIC_MATCHERS, injector) {
        this.DYNAMIC_MATCHERS = DYNAMIC_MATCHERS;
        this.injector = injector;
    }
    /**
     * @param {?} group
     * @param {?} condition
     * @return {?}
     */
    DynamicFormRelationService.prototype.getRelatedFormControl = /**
     * @param {?} group
     * @param {?} condition
     * @return {?}
     */
    function (group, condition) {
        /** @type {?} */
        var control = condition.rootPath ?
            (/** @type {?} */ (group.root.get(condition.rootPath))) : (/** @type {?} */ (group.get(condition.id)));
        if (control === null) {
            throw new Error("No related form control with id " + condition.id + " could be found");
        }
        return control;
    };
    /**
     * @param {?} model
     * @param {?} group
     * @return {?}
     */
    DynamicFormRelationService.prototype.getRelatedFormControls = /**
     * @param {?} model
     * @param {?} group
     * @return {?}
     */
    function (model, group) {
        var _this = this;
        /** @type {?} */
        var controls = {};
        model.relations.forEach((/**
         * @param {?} relation
         * @return {?}
         */
        function (relation) { return relation.when.forEach((/**
         * @param {?} condition
         * @return {?}
         */
        function (condition) {
            if (model.id === condition.id) {
                throw new Error("FormControl " + model.id + " cannot depend on itself");
            }
            /** @type {?} */
            var control = _this.getRelatedFormControl(group, condition);
            if (control && !controls.hasOwnProperty(model.id)) {
                controls[condition.id] = control;
            }
        })); }));
        return controls;
    };
    /**
     * @param {?} relations
     * @param {?} matcher
     * @return {?}
     */
    DynamicFormRelationService.prototype.findRelation = /**
     * @param {?} relations
     * @param {?} matcher
     * @return {?}
     */
    function (relations, matcher) {
        return relations.find((/**
         * @param {?} relation
         * @return {?}
         */
        function (relation) { return relation.match === matcher.match || relation.match === matcher.opposingMatch; })) || null;
    };
    /**
     * @param {?} relation
     * @param {?} group
     * @param {?} matcher
     * @return {?}
     */
    DynamicFormRelationService.prototype.matchesCondition = /**
     * @param {?} relation
     * @param {?} group
     * @param {?} matcher
     * @return {?}
     */
    function (relation, group, matcher) {
        var _this = this;
        /** @type {?} */
        var operator = relation.operator || OR_OPERATOR;
        return relation.when.reduce((/**
         * @param {?} hasAlreadyMatched
         * @param {?} condition
         * @param {?} index
         * @return {?}
         */
        function (hasAlreadyMatched, condition, index) {
            /** @type {?} */
            var relatedControl = _this.getRelatedFormControl(group, condition);
            if (relatedControl && relation.match === matcher.match) {
                if (index > 0 && operator === AND_OPERATOR && !hasAlreadyMatched) {
                    return false;
                }
                if (index > 0 && operator === OR_OPERATOR && hasAlreadyMatched) {
                    return true;
                }
                return condition.value === relatedControl.value || condition.status === relatedControl.status;
            }
            if (relatedControl && relation.match === matcher.opposingMatch) {
                if (index > 0 && operator === AND_OPERATOR && hasAlreadyMatched) {
                    return true;
                }
                if (index > 0 && operator === OR_OPERATOR && !hasAlreadyMatched) {
                    return false;
                }
                return !(condition.value === relatedControl.value || condition.status === relatedControl.status);
            }
            return false;
        }), false);
    };
    /**
     * @param {?} model
     * @param {?} group
     * @param {?} control
     * @return {?}
     */
    DynamicFormRelationService.prototype.subscribeRelations = /**
     * @param {?} model
     * @param {?} group
     * @param {?} control
     * @return {?}
     */
    function (model, group, control) {
        var _this = this;
        /** @type {?} */
        var relatedFormControls = this.getRelatedFormControls(model, group);
        /** @type {?} */
        var subscriptions = [];
        Object.entries(relatedFormControls).forEach((/**
         * @param {?} __0
         * @return {?}
         */
        function (_a) {
            var _b = tslib_1.__read(_a, 2), _id = _b[0], relatedControl = _b[1];
            /** @type {?} */
            var valueChanges = relatedControl.valueChanges.pipe(startWith(relatedControl.value));
            /** @type {?} */
            var statusChanges = relatedControl.statusChanges.pipe(startWith(relatedControl.status));
            subscriptions.push(merge(valueChanges, statusChanges).subscribe((/**
             * @return {?}
             */
            function () {
                if (Array.isArray(_this.DYNAMIC_MATCHERS)) {
                    _this.DYNAMIC_MATCHERS.forEach((/**
                     * @param {?} matcher
                     * @return {?}
                     */
                    function (matcher) {
                        /** @type {?} */
                        var relation = _this.findRelation(model.relations, matcher);
                        if (relation) {
                            /** @type {?} */
                            var hasMatch = _this.matchesCondition(relation, group, matcher);
                            matcher.onChange(hasMatch, model, control, _this.injector);
                        }
                    }));
                }
            })));
        }));
        return subscriptions;
    };
    DynamicFormRelationService.decorators = [
        { type: Injectable, args: [{
                    providedIn: "root"
                },] }
    ];
    /** @nocollapse */
    DynamicFormRelationService.ctorParameters = function () { return [
        { type: Array, decorators: [{ type: Optional }, { type: Inject, args: [DYNAMIC_MATCHERS,] }] },
        { type: Injector }
    ]; };
    /** @nocollapse */ DynamicFormRelationService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function DynamicFormRelationService_Factory() { return new DynamicFormRelationService(i0.ɵɵinject(i1.DYNAMIC_MATCHERS, 8), i0.ɵɵinject(i0.INJECTOR)); }, token: DynamicFormRelationService, providedIn: "root" });
    return DynamicFormRelationService;
}());
export { DynamicFormRelationService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    DynamicFormRelationService.prototype.DYNAMIC_MATCHERS;
    /**
     * @type {?}
     * @private
     */
    DynamicFormRelationService.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy1mb3JtLXJlbGF0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AbmctZHluYW1pYy1mb3Jtcy9jb3JlLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2UvZHluYW1pYy1mb3JtLXJlbGF0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBR3ZFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBNkIsTUFBTSxrQ0FBa0MsQ0FBQztBQUMvRixPQUFPLEVBQ0gsWUFBWSxFQUdaLFdBQVcsRUFDZCxNQUFNLG1EQUFtRCxDQUFDO0FBQzNELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzQyxPQUFPLEVBQUUsS0FBSyxFQUFnQixNQUFNLE1BQU0sQ0FBQzs7O0FBRTNDO0lBS0ksb0NBQTBELGdCQUE2QyxFQUNuRixRQUFrQjtRQURvQixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQTZCO1FBQ25GLGFBQVEsR0FBUixRQUFRLENBQVU7SUFBRyxDQUFDOzs7Ozs7SUFFMUMsMERBQXFCOzs7OztJQUFyQixVQUFzQixLQUFnQixFQUFFLFNBQXNDOztZQUVwRSxPQUFPLEdBQUcsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ2hDLG1CQUFBLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsRUFBZSxDQUFDLENBQUMsQ0FBQyxtQkFBQSxLQUFLLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsRUFBZTtRQUU5RixJQUFJLE9BQU8sS0FBSyxJQUFJLEVBQUU7WUFDbEIsTUFBTSxJQUFJLEtBQUssQ0FBQyxxQ0FBbUMsU0FBUyxDQUFDLEVBQUUsb0JBQWlCLENBQUMsQ0FBQztTQUNyRjtRQUVELE9BQU8sT0FBTyxDQUFDO0lBQ25C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QkFDTjtZQUNMLENBQUMsRUFBQyxDQUFDLENBQUM7UUFDUixDQUFDLEVBQUMsQ0FBQztRQUVILE9BQU8sYUFBYSxDQUFDO0lBQ3pCLENBQUM7O2dCQS9HSixVQUFVLFNBQUM7b0JBQ1IsVUFBVSxFQUFFLE1BQU07aUJBQ3JCOzs7OzRDQUdnQixRQUFRLFlBQUksTUFBTSxTQUFDLGdCQUFnQjtnQkFsQnZCLFFBQVE7OztxQ0FBckM7Q0E2SEMsQUFoSEQsSUFnSEM7U0E3R1ksMEJBQTBCOzs7Ozs7SUFFdkIsc0RBQTJGOzs7OztJQUMzRiw4Q0FBMEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdG9yLCBPcHRpb25hbCB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQgeyBGb3JtQ29udHJvbCwgRm9ybUdyb3VwIH0gZnJvbSBcIkBhbmd1bGFyL2Zvcm1zXCI7XG5pbXBvcnQgeyBEeW5hbWljRm9ybUNvbnRyb2xNb2RlbCB9IGZyb20gXCIuLi9tb2RlbC9keW5hbWljLWZvcm0tY29udHJvbC5tb2RlbFwiO1xuaW1wb3J0IHsgRFlOQU1JQ19NQVRDSEVSUywgRHluYW1pY0Zvcm1Db250cm9sTWF0Y2hlciB9IGZyb20gXCIuL2R5bmFtaWMtZm9ybS1yZWxhdGlvbi5tYXRjaGVyc1wiO1xuaW1wb3J0IHtcbiAgICBBTkRfT1BFUkFUT1IsXG4gICAgRHluYW1pY0Zvcm1Db250cm9sQ29uZGl0aW9uLFxuICAgIER5bmFtaWNGb3JtQ29udHJvbFJlbGF0aW9uLFxuICAgIE9SX09QRVJBVE9SXG59IGZyb20gXCIuLi9tb2RlbC9taXNjL2R5bmFtaWMtZm9ybS1jb250cm9sLXJlbGF0aW9uLm1vZGVsXCI7XG5pbXBvcnQgeyBzdGFydFdpdGggfSBmcm9tIFwicnhqcy9vcGVyYXRvcnNcIjtcbmltcG9ydCB7IG1lcmdlLCBTdWJzY3JpcHRpb24gfSBmcm9tIFwicnhqc1wiO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogXCJyb290XCJcbn0pXG5leHBvcnQgY2xhc3MgRHluYW1pY0Zvcm1SZWxhdGlvblNlcnZpY2Uge1xuXG4gICAgY29uc3RydWN0b3IoQE9wdGlvbmFsKCkgQEluamVjdChEWU5BTUlDX01BVENIRVJTKSBwcml2YXRlIERZTkFNSUNfTUFUQ0hFUlM6IER5bmFtaWNGb3JtQ29udHJvbE1hdGNoZXJbXSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGluamVjdG9yOiBJbmplY3Rvcikge31cblxuICAgIGdldFJlbGF0ZWRGb3JtQ29udHJvbChncm91cDogRm9ybUdyb3VwLCBjb25kaXRpb246IER5bmFtaWNGb3JtQ29udHJvbENvbmRpdGlvbik6IEZvcm1Db250cm9sIHwgbmV2ZXIge1xuXG4gICAgICAgIGNvbnN0IGNvbnRyb2wgPSBjb25kaXRpb24ucm9vdFBhdGggP1xuICAgICAgICAgICAgZ3JvdXAucm9vdC5nZXQoY29uZGl0aW9uLnJvb3RQYXRoKSBhcyBGb3JtQ29udHJvbCA6IGdyb3VwLmdldChjb25kaXRpb24uaWQpIGFzIEZvcm1Db250cm9sO1xuXG4gICAgICAgIGlmIChjb250cm9sID09PSBudWxsKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIHJlbGF0ZWQgZm9ybSBjb250cm9sIHdpdGggaWQgJHtjb25kaXRpb24uaWR9IGNvdWxkIGJlIGZvdW5kYCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gY29udHJvbDtcbiAgICB9XG5cbiAgICBnZXRSZWxhdGVkRm9ybUNvbnRyb2xzKG1vZGVsOiBEeW5hbWljRm9ybUNvbnRyb2xNb2RlbCwgZ3JvdXA6IEZvcm1Hcm91cCk6IHsgW2lkOiBzdHJpbmddOiBGb3JtQ29udHJvbCB9IHwgbmV2ZXIge1xuXG4gICAgICAgIGNvbnN0IGNvbnRyb2xzOiB7IFtpZDogc3RyaW5nXTogRm9ybUNvbnRyb2wgfSA9IHt9O1xuXG4gICAgICAgIG1vZGVsLnJlbGF0aW9ucy5mb3JFYWNoKHJlbGF0aW9uID0+IHJlbGF0aW9uLndoZW4uZm9yRWFjaChjb25kaXRpb24gPT4ge1xuXG4gICAgICAgICAgICBpZiAobW9kZWwuaWQgPT09IGNvbmRpdGlvbi5pZCkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRm9ybUNvbnRyb2wgJHttb2RlbC5pZH0gY2Fubm90IGRlcGVuZCBvbiBpdHNlbGZgKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgY29udHJvbCA9IHRoaXMuZ2V0UmVsYXRlZEZvcm1Db250cm9sKGdyb3VwLCBjb25kaXRpb24pO1xuXG4gICAgICAgICAgICBpZiAoY29udHJvbCAmJiAhY29udHJvbHMuaGFzT3duUHJvcGVydHkobW9kZWwuaWQpKSB7XG4gICAgICAgICAgICAgICAgY29udHJvbHNbY29uZGl0aW9uLmlkXSA9IGNvbnRyb2w7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pKTtcblxuICAgICAgICByZXR1cm4gY29udHJvbHM7XG4gICAgfVxuXG4gICAgZmluZFJlbGF0aW9uKHJlbGF0aW9uczogRHluYW1pY0Zvcm1Db250cm9sUmVsYXRpb25bXSwgbWF0Y2hlcjogRHluYW1pY0Zvcm1Db250cm9sTWF0Y2hlcik6IER5bmFtaWNGb3JtQ29udHJvbFJlbGF0aW9uIHwgbnVsbCB7XG4gICAgICAgIHJldHVybiByZWxhdGlvbnMuZmluZChyZWxhdGlvbiA9PiByZWxhdGlvbi5tYXRjaCA9PT0gbWF0Y2hlci5tYXRjaCB8fCByZWxhdGlvbi5tYXRjaCA9PT0gbWF0Y2hlci5vcHBvc2luZ01hdGNoKSB8fCBudWxsO1xuICAgIH1cblxuICAgIG1hdGNoZXNDb25kaXRpb24ocmVsYXRpb246IER5bmFtaWNGb3JtQ29udHJvbFJlbGF0aW9uLCBncm91cDogRm9ybUdyb3VwLCBtYXRjaGVyOiBEeW5hbWljRm9ybUNvbnRyb2xNYXRjaGVyKTogYm9vbGVhbiB7XG5cbiAgICAgICAgY29uc3Qgb3BlcmF0b3IgPSByZWxhdGlvbi5vcGVyYXRvciB8fCBPUl9PUEVSQVRPUjtcblxuICAgICAgICByZXR1cm4gcmVsYXRpb24ud2hlbi5yZWR1Y2UoKGhhc0FscmVhZHlNYXRjaGVkOiBib29sZWFuLCBjb25kaXRpb246IER5bmFtaWNGb3JtQ29udHJvbENvbmRpdGlvbiwgaW5kZXg6IG51bWJlcikgPT4ge1xuXG4gICAgICAgICAgICBjb25zdCByZWxhdGVkQ29udHJvbCA9IHRoaXMuZ2V0UmVsYXRlZEZvcm1Db250cm9sKGdyb3VwLCBjb25kaXRpb24pO1xuXG4gICAgICAgICAgICBpZiAocmVsYXRlZENvbnRyb2wgJiYgcmVsYXRpb24ubWF0Y2ggPT09IG1hdGNoZXIubWF0Y2gpIHtcblxuICAgICAgICAgICAgICAgIGlmIChpbmRleCA+IDAgJiYgb3BlcmF0b3IgPT09IEFORF9PUEVSQVRPUiAmJiAhaGFzQWxyZWFkeU1hdGNoZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChpbmRleCA+IDAgJiYgb3BlcmF0b3IgPT09IE9SX09QRVJBVE9SICYmIGhhc0FscmVhZHlNYXRjaGVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiBjb25kaXRpb24udmFsdWUgPT09IHJlbGF0ZWRDb250cm9sLnZhbHVlIHx8IGNvbmRpdGlvbi5zdGF0dXMgPT09IHJlbGF0ZWRDb250cm9sLnN0YXR1cztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHJlbGF0ZWRDb250cm9sICYmIHJlbGF0aW9uLm1hdGNoID09PSBtYXRjaGVyLm9wcG9zaW5nTWF0Y2gpIHtcblxuICAgICAgICAgICAgICAgIGlmIChpbmRleCA+IDAgJiYgb3BlcmF0b3IgPT09IEFORF9PUEVSQVRPUiAmJiBoYXNBbHJlYWR5TWF0Y2hlZCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoaW5kZXggPiAwICYmIG9wZXJhdG9yID09PSBPUl9PUEVSQVRPUiAmJiAhaGFzQWxyZWFkeU1hdGNoZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiAhKGNvbmRpdGlvbi52YWx1ZSA9PT0gcmVsYXRlZENvbnRyb2wudmFsdWUgfHwgY29uZGl0aW9uLnN0YXR1cyA9PT0gcmVsYXRlZENvbnRyb2wuc3RhdHVzKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgIH0sIGZhbHNlKTtcbiAgICB9XG5cbiAgICBzdWJzY3JpYmVSZWxhdGlvbnMobW9kZWw6IER5bmFtaWNGb3JtQ29udHJvbE1vZGVsLCBncm91cDogRm9ybUdyb3VwLCBjb250cm9sOiBGb3JtQ29udHJvbCk6IFN1YnNjcmlwdGlvbltdIHtcblxuICAgICAgICBjb25zdCByZWxhdGVkRm9ybUNvbnRyb2xzID0gdGhpcy5nZXRSZWxhdGVkRm9ybUNvbnRyb2xzKG1vZGVsLCBncm91cCksIHN1YnNjcmlwdGlvbnM6IFN1YnNjcmlwdGlvbltdID0gW107XG5cbiAgICAgICAgT2JqZWN0LmVudHJpZXMocmVsYXRlZEZvcm1Db250cm9scykuZm9yRWFjaCgoW19pZCwgcmVsYXRlZENvbnRyb2xdKSA9PiB7XG5cbiAgICAgICAgICAgIGNvbnN0IHZhbHVlQ2hhbmdlcyA9IHJlbGF0ZWRDb250cm9sLnZhbHVlQ2hhbmdlcy5waXBlKHN0YXJ0V2l0aChyZWxhdGVkQ29udHJvbC52YWx1ZSkpO1xuICAgICAgICAgICAgY29uc3Qgc3RhdHVzQ2hhbmdlcyA9IHJlbGF0ZWRDb250cm9sLnN0YXR1c0NoYW5nZXMucGlwZShzdGFydFdpdGgocmVsYXRlZENvbnRyb2wuc3RhdHVzKSk7XG5cbiAgICAgICAgICAgIHN1YnNjcmlwdGlvbnMucHVzaChtZXJnZSh2YWx1ZUNoYW5nZXMsIHN0YXR1c0NoYW5nZXMpLnN1YnNjcmliZSgoKSA9PiB7XG5cbiAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh0aGlzLkRZTkFNSUNfTUFUQ0hFUlMpKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5EWU5BTUlDX01BVENIRVJTLmZvckVhY2gobWF0Y2hlciA9PiB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlbGF0aW9uID0gdGhpcy5maW5kUmVsYXRpb24obW9kZWwucmVsYXRpb25zLCBtYXRjaGVyKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlbGF0aW9uKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBoYXNNYXRjaCA9IHRoaXMubWF0Y2hlc0NvbmRpdGlvbihyZWxhdGlvbiwgZ3JvdXAsIG1hdGNoZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoZXIub25DaGFuZ2UoaGFzTWF0Y2gsIG1vZGVsLCBjb250cm9sLCB0aGlzLmluamVjdG9yKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSkpO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gc3Vic2NyaXB0aW9ucztcbiAgICB9XG59XG4iXX0=