/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Inject, Injectable, Injector, Optional } from "@angular/core";
import { DYNAMIC_MATCHERS } from "./dynamic-form-relation.matchers";
import { AND_OPERATOR, OR_OPERATOR } from "../model/misc/dynamic-form-control-relation.model";
import { startWith } from "rxjs/operators";
import { merge } from "rxjs";
import * as i0 from "@angular/core";
import * as i1 from "./dynamic-form-relation.matchers";
export class DynamicFormRelationService {
    /**
     * @param {?} DYNAMIC_MATCHERS
     * @param {?} injector
     */
    constructor(DYNAMIC_MATCHERS, injector) {
        this.DYNAMIC_MATCHERS = DYNAMIC_MATCHERS;
        this.injector = injector;
    }
    /**
     * @param {?} group
     * @param {?} condition
     * @return {?}
     */
    getRelatedFormControl(group, condition) {
        /** @type {?} */
        const control = condition.rootPath ?
            (/** @type {?} */ (group.root.get(condition.rootPath))) : (/** @type {?} */ (group.get(condition.id)));
        if (control === null) {
            throw new Error(`No related form control with id ${condition.id} could be found`);
        }
        return control;
    }
    /**
     * @param {?} model
     * @param {?} group
     * @return {?}
     */
    getRelatedFormControls(model, group) {
        /** @type {?} */
        const controls = {};
        model.relations.forEach((/**
         * @param {?} relation
         * @return {?}
         */
        relation => relation.when.forEach((/**
         * @param {?} condition
         * @return {?}
         */
        condition => {
            if (model.id === condition.id) {
                throw new Error(`FormControl ${model.id} cannot depend on itself`);
            }
            /** @type {?} */
            const control = this.getRelatedFormControl(group, condition);
            if (control && !controls.hasOwnProperty(model.id)) {
                controls[condition.id] = control;
            }
        }))));
        return controls;
    }
    /**
     * @param {?} relations
     * @param {?} matcher
     * @return {?}
     */
    findRelation(relations, matcher) {
        return relations.find((/**
         * @param {?} relation
         * @return {?}
         */
        relation => relation.match === matcher.match || relation.match === matcher.opposingMatch)) || null;
    }
    /**
     * @param {?} relation
     * @param {?} group
     * @param {?} matcher
     * @return {?}
     */
    matchesCondition(relation, group, matcher) {
        /** @type {?} */
        const operator = relation.operator || OR_OPERATOR;
        return relation.when.reduce((/**
         * @param {?} hasAlreadyMatched
         * @param {?} condition
         * @param {?} index
         * @return {?}
         */
        (hasAlreadyMatched, condition, index) => {
            /** @type {?} */
            const relatedControl = this.getRelatedFormControl(group, condition);
            if (relatedControl && relation.match === matcher.match) {
                if (index > 0 && operator === AND_OPERATOR && !hasAlreadyMatched) {
                    return false;
                }
                if (index > 0 && operator === OR_OPERATOR && hasAlreadyMatched) {
                    return true;
                }
                return condition.value === relatedControl.value || condition.status === relatedControl.status;
            }
            if (relatedControl && relation.match === matcher.opposingMatch) {
                if (index > 0 && operator === AND_OPERATOR && hasAlreadyMatched) {
                    return true;
                }
                if (index > 0 && operator === OR_OPERATOR && !hasAlreadyMatched) {
                    return false;
                }
                return !(condition.value === relatedControl.value || condition.status === relatedControl.status);
            }
            return false;
        }), false);
    }
    /**
     * @param {?} model
     * @param {?} group
     * @param {?} control
     * @return {?}
     */
    subscribeRelations(model, group, control) {
        /** @type {?} */
        const relatedFormControls = this.getRelatedFormControls(model, group);
        /** @type {?} */
        const subscriptions = [];
        Object.entries(relatedFormControls).forEach((/**
         * @param {?} __0
         * @return {?}
         */
        ([_id, relatedControl]) => {
            /** @type {?} */
            const valueChanges = relatedControl.valueChanges.pipe(startWith(relatedControl.value));
            /** @type {?} */
            const statusChanges = relatedControl.statusChanges.pipe(startWith(relatedControl.status));
            subscriptions.push(merge(valueChanges, statusChanges).subscribe((/**
             * @return {?}
             */
            () => {
                if (Array.isArray(this.DYNAMIC_MATCHERS)) {
                    this.DYNAMIC_MATCHERS.forEach((/**
                     * @param {?} matcher
                     * @return {?}
                     */
                    matcher => {
                        /** @type {?} */
                        const relation = this.findRelation(model.relations, matcher);
                        if (relation) {
                            /** @type {?} */
                            const hasMatch = this.matchesCondition(relation, group, matcher);
                            matcher.onChange(hasMatch, model, control, this.injector);
                        }
                    }));
                }
            })));
        }));
        return subscriptions;
    }
}
DynamicFormRelationService.decorators = [
    { type: Injectable, args: [{
                providedIn: "root"
            },] }
];
/** @nocollapse */
DynamicFormRelationService.ctorParameters = () => [
    { type: Array, decorators: [{ type: Optional }, { type: Inject, args: [DYNAMIC_MATCHERS,] }] },
    { type: Injector }
];
/** @nocollapse */ DynamicFormRelationService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function DynamicFormRelationService_Factory() { return new DynamicFormRelationService(i0.ɵɵinject(i1.DYNAMIC_MATCHERS, 8), i0.ɵɵinject(i0.INJECTOR)); }, token: DynamicFormRelationService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    DynamicFormRelationService.prototype.DYNAMIC_MATCHERS;
    /**
     * @type {?}
     * @private
     */
    DynamicFormRelationService.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy1mb3JtLXJlbGF0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AbmctZHluYW1pYy1mb3Jtcy9jb3JlLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2UvZHluYW1pYy1mb3JtLXJlbGF0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHdkUsT0FBTyxFQUFFLGdCQUFnQixFQUE2QixNQUFNLGtDQUFrQyxDQUFDO0FBQy9GLE9BQU8sRUFDSCxZQUFZLEVBR1osV0FBVyxFQUNkLE1BQU0sbURBQW1ELENBQUM7QUFDM0QsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxLQUFLLEVBQWdCLE1BQU0sTUFBTSxDQUFDOzs7QUFLM0MsTUFBTSxPQUFPLDBCQUEwQjs7Ozs7SUFFbkMsWUFBMEQsZ0JBQTZDLEVBQ25GLFFBQWtCO1FBRG9CLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBNkI7UUFDbkYsYUFBUSxHQUFSLFFBQVEsQ0FBVTtJQUFHLENBQUM7Ozs7OztJQUUxQyxxQkFBcUIsQ0FBQyxLQUFnQixFQUFFLFNBQXNDOztjQUVwRSxPQUFPLEdBQUcsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ2hDLG1CQUFBLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsRUFBZSxDQUFDLENBQUMsQ0FBQyxtQkFBQSxLQUFLLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsRUFBZTtRQUU5RixJQUFJLE9BQU8sS0FBSyxJQUFJLEVBQUU7WUFDbEIsTUFBTSxJQUFJLEtBQUssQ0FBQyxtQ0FBbUMsU0FBUyxDQUFDLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztTQUNyRjtRQUVELE9BQU8sT0FBTyxD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QUFDOzs7WUEvR0osVUFBVSxTQUFDO2dCQUNSLFVBQVUsRUFBRSxNQUFNO2FBQ3JCOzs7O3dDQUdnQixRQUFRLFlBQUksTUFBTSxTQUFDLGdCQUFnQjtZQWxCdkIsUUFBUTs7Ozs7Ozs7SUFrQnJCLHNEQUEyRjs7Ozs7SUFDM0YsOENBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBJbmplY3RvciwgT3B0aW9uYWwgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHsgRm9ybUNvbnRyb2wsIEZvcm1Hcm91cCB9IGZyb20gXCJAYW5ndWxhci9mb3Jtc1wiO1xuaW1wb3J0IHsgRHluYW1pY0Zvcm1Db250cm9sTW9kZWwgfSBmcm9tIFwiLi4vbW9kZWwvZHluYW1pYy1mb3JtLWNvbnRyb2wubW9kZWxcIjtcbmltcG9ydCB7IERZTkFNSUNfTUFUQ0hFUlMsIER5bmFtaWNGb3JtQ29udHJvbE1hdGNoZXIgfSBmcm9tIFwiLi9keW5hbWljLWZvcm0tcmVsYXRpb24ubWF0Y2hlcnNcIjtcbmltcG9ydCB7XG4gICAgQU5EX09QRVJBVE9SLFxuICAgIER5bmFtaWNGb3JtQ29udHJvbENvbmRpdGlvbixcbiAgICBEeW5hbWljRm9ybUNvbnRyb2xSZWxhdGlvbixcbiAgICBPUl9PUEVSQVRPUlxufSBmcm9tIFwiLi4vbW9kZWwvbWlzYy9keW5hbWljLWZvcm0tY29udHJvbC1yZWxhdGlvbi5tb2RlbFwiO1xuaW1wb3J0IHsgc3RhcnRXaXRoIH0gZnJvbSBcInJ4anMvb3BlcmF0b3JzXCI7XG5pbXBvcnQgeyBtZXJnZSwgU3Vic2NyaXB0aW9uIH0gZnJvbSBcInJ4anNcIjtcblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46IFwicm9vdFwiXG59KVxuZXhwb3J0IGNsYXNzIER5bmFtaWNGb3JtUmVsYXRpb25TZXJ2aWNlIHtcblxuICAgIGNvbnN0cnVjdG9yKEBPcHRpb25hbCgpIEBJbmplY3QoRFlOQU1JQ19NQVRDSEVSUykgcHJpdmF0ZSBEWU5BTUlDX01BVENIRVJTOiBEeW5hbWljRm9ybUNvbnRyb2xNYXRjaGVyW10sXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IpIHt9XG5cbiAgICBnZXRSZWxhdGVkRm9ybUNvbnRyb2woZ3JvdXA6IEZvcm1Hcm91cCwgY29uZGl0aW9uOiBEeW5hbWljRm9ybUNvbnRyb2xDb25kaXRpb24pOiBGb3JtQ29udHJvbCB8IG5ldmVyIHtcblxuICAgICAgICBjb25zdCBjb250cm9sID0gY29uZGl0aW9uLnJvb3RQYXRoID9cbiAgICAgICAgICAgIGdyb3VwLnJvb3QuZ2V0KGNvbmRpdGlvbi5yb290UGF0aCkgYXMgRm9ybUNvbnRyb2wgOiBncm91cC5nZXQoY29uZGl0aW9uLmlkKSBhcyBGb3JtQ29udHJvbDtcblxuICAgICAgICBpZiAoY29udHJvbCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyByZWxhdGVkIGZvcm0gY29udHJvbCB3aXRoIGlkICR7Y29uZGl0aW9uLmlkfSBjb3VsZCBiZSBmb3VuZGApO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGNvbnRyb2w7XG4gICAgfVxuXG4gICAgZ2V0UmVsYXRlZEZvcm1Db250cm9scyhtb2RlbDogRHluYW1pY0Zvcm1Db250cm9sTW9kZWwsIGdyb3VwOiBGb3JtR3JvdXApOiB7IFtpZDogc3RyaW5nXTogRm9ybUNvbnRyb2wgfSB8IG5ldmVyIHtcblxuICAgICAgICBjb25zdCBjb250cm9sczogeyBbaWQ6IHN0cmluZ106IEZvcm1Db250cm9sIH0gPSB7fTtcblxuICAgICAgICBtb2RlbC5yZWxhdGlvbnMuZm9yRWFjaChyZWxhdGlvbiA9PiByZWxhdGlvbi53aGVuLmZvckVhY2goY29uZGl0aW9uID0+IHtcblxuICAgICAgICAgICAgaWYgKG1vZGVsLmlkID09PSBjb25kaXRpb24uaWQpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZvcm1Db250cm9sICR7bW9kZWwuaWR9IGNhbm5vdCBkZXBlbmQgb24gaXRzZWxmYCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IGNvbnRyb2wgPSB0aGlzLmdldFJlbGF0ZWRGb3JtQ29udHJvbChncm91cCwgY29uZGl0aW9uKTtcblxuICAgICAgICAgICAgaWYgKGNvbnRyb2wgJiYgIWNvbnRyb2xzLmhhc093blByb3BlcnR5KG1vZGVsLmlkKSkge1xuICAgICAgICAgICAgICAgIGNvbnRyb2xzW2NvbmRpdGlvbi5pZF0gPSBjb250cm9sO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KSk7XG5cbiAgICAgICAgcmV0dXJuIGNvbnRyb2xzO1xuICAgIH1cblxuICAgIGZpbmRSZWxhdGlvbihyZWxhdGlvbnM6IER5bmFtaWNGb3JtQ29udHJvbFJlbGF0aW9uW10sIG1hdGNoZXI6IER5bmFtaWNGb3JtQ29udHJvbE1hdGNoZXIpOiBEeW5hbWljRm9ybUNvbnRyb2xSZWxhdGlvbiB8IG51bGwge1xuICAgICAgICByZXR1cm4gcmVsYXRpb25zLmZpbmQocmVsYXRpb24gPT4gcmVsYXRpb24ubWF0Y2ggPT09IG1hdGNoZXIubWF0Y2ggfHwgcmVsYXRpb24ubWF0Y2ggPT09IG1hdGNoZXIub3Bwb3NpbmdNYXRjaCkgfHwgbnVsbDtcbiAgICB9XG5cbiAgICBtYXRjaGVzQ29uZGl0aW9uKHJlbGF0aW9uOiBEeW5hbWljRm9ybUNvbnRyb2xSZWxhdGlvbiwgZ3JvdXA6IEZvcm1Hcm91cCwgbWF0Y2hlcjogRHluYW1pY0Zvcm1Db250cm9sTWF0Y2hlcik6IGJvb2xlYW4ge1xuXG4gICAgICAgIGNvbnN0IG9wZXJhdG9yID0gcmVsYXRpb24ub3BlcmF0b3IgfHwgT1JfT1BFUkFUT1I7XG5cbiAgICAgICAgcmV0dXJuIHJlbGF0aW9uLndoZW4ucmVkdWNlKChoYXNBbHJlYWR5TWF0Y2hlZDogYm9vbGVhbiwgY29uZGl0aW9uOiBEeW5hbWljRm9ybUNvbnRyb2xDb25kaXRpb24sIGluZGV4OiBudW1iZXIpID0+IHtcblxuICAgICAgICAgICAgY29uc3QgcmVsYXRlZENvbnRyb2wgPSB0aGlzLmdldFJlbGF0ZWRGb3JtQ29udHJvbChncm91cCwgY29uZGl0aW9uKTtcblxuICAgICAgICAgICAgaWYgKHJlbGF0ZWRDb250cm9sICYmIHJlbGF0aW9uLm1hdGNoID09PSBtYXRjaGVyLm1hdGNoKSB7XG5cbiAgICAgICAgICAgICAgICBpZiAoaW5kZXggPiAwICYmIG9wZXJhdG9yID09PSBBTkRfT1BFUkFUT1IgJiYgIWhhc0FscmVhZHlNYXRjaGVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoaW5kZXggPiAwICYmIG9wZXJhdG9yID09PSBPUl9PUEVSQVRPUiAmJiBoYXNBbHJlYWR5TWF0Y2hlZCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gY29uZGl0aW9uLnZhbHVlID09PSByZWxhdGVkQ29udHJvbC52YWx1ZSB8fCBjb25kaXRpb24uc3RhdHVzID09PSByZWxhdGVkQ29udHJvbC5zdGF0dXM7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChyZWxhdGVkQ29udHJvbCAmJiByZWxhdGlvbi5tYXRjaCA9PT0gbWF0Y2hlci5vcHBvc2luZ01hdGNoKSB7XG5cbiAgICAgICAgICAgICAgICBpZiAoaW5kZXggPiAwICYmIG9wZXJhdG9yID09PSBBTkRfT1BFUkFUT1IgJiYgaGFzQWxyZWFkeU1hdGNoZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKGluZGV4ID4gMCAmJiBvcGVyYXRvciA9PT0gT1JfT1BFUkFUT1IgJiYgIWhhc0FscmVhZHlNYXRjaGVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gIShjb25kaXRpb24udmFsdWUgPT09IHJlbGF0ZWRDb250cm9sLnZhbHVlIHx8IGNvbmRpdGlvbi5zdGF0dXMgPT09IHJlbGF0ZWRDb250cm9sLnN0YXR1cyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcblxuICAgICAgICB9LCBmYWxzZSk7XG4gICAgfVxuXG4gICAgc3Vic2NyaWJlUmVsYXRpb25zKG1vZGVsOiBEeW5hbWljRm9ybUNvbnRyb2xNb2RlbCwgZ3JvdXA6IEZvcm1Hcm91cCwgY29udHJvbDogRm9ybUNvbnRyb2wpOiBTdWJzY3JpcHRpb25bXSB7XG5cbiAgICAgICAgY29uc3QgcmVsYXRlZEZvcm1Db250cm9scyA9IHRoaXMuZ2V0UmVsYXRlZEZvcm1Db250cm9scyhtb2RlbCwgZ3JvdXApLCBzdWJzY3JpcHRpb25zOiBTdWJzY3JpcHRpb25bXSA9IFtdO1xuXG4gICAgICAgIE9iamVjdC5lbnRyaWVzKHJlbGF0ZWRGb3JtQ29udHJvbHMpLmZvckVhY2goKFtfaWQsIHJlbGF0ZWRDb250cm9sXSkgPT4ge1xuXG4gICAgICAgICAgICBjb25zdCB2YWx1ZUNoYW5nZXMgPSByZWxhdGVkQ29udHJvbC52YWx1ZUNoYW5nZXMucGlwZShzdGFydFdpdGgocmVsYXRlZENvbnRyb2wudmFsdWUpKTtcbiAgICAgICAgICAgIGNvbnN0IHN0YXR1c0NoYW5nZXMgPSByZWxhdGVkQ29udHJvbC5zdGF0dXNDaGFuZ2VzLnBpcGUoc3RhcnRXaXRoKHJlbGF0ZWRDb250cm9sLnN0YXR1cykpO1xuXG4gICAgICAgICAgICBzdWJzY3JpcHRpb25zLnB1c2gobWVyZ2UodmFsdWVDaGFuZ2VzLCBzdGF0dXNDaGFuZ2VzKS5zdWJzY3JpYmUoKCkgPT4ge1xuXG4gICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodGhpcy5EWU5BTUlDX01BVENIRVJTKSkge1xuXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuRFlOQU1JQ19NQVRDSEVSUy5mb3JFYWNoKG1hdGNoZXIgPT4ge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZWxhdGlvbiA9IHRoaXMuZmluZFJlbGF0aW9uKG1vZGVsLnJlbGF0aW9ucywgbWF0Y2hlcik7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZWxhdGlvbikge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaGFzTWF0Y2ggPSB0aGlzLm1hdGNoZXNDb25kaXRpb24ocmVsYXRpb24sIGdyb3VwLCBtYXRjaGVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaGVyLm9uQ2hhbmdlKGhhc01hdGNoLCBtb2RlbCwgY29udHJvbCwgdGhpcy5pbmplY3Rvcik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHN1YnNjcmlwdGlvbnM7XG4gICAgfVxufVxuIl19